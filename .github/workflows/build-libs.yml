name: Build native libs

on:
  workflow_dispatch:

jobs:
  build:
    name: Build SDL & add-ons for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, windows-2025, windows-11-arm, macos-13, macos-latest]

    env:
      INSTALL_PREFIX: ${{ github.workspace }}/install
      BUILD_DIR: ${{ github.workspace }}/build
      CMAKE_BUILD_TYPE: Release

    steps:
      # ---------- SDL core (edwardgushchin/SDL, default branch = main) ----------
      - name: Clone SDL
        uses: actions/checkout@v4
        with:
          repository: edwardgushchin/SDL
          # ref: main  # можно не указывать, берется default branch
          fetch-depth: 1
          submodules: recursive
          path: SDL

      # ---------- Linux deps ----------
      - name: Install Linux deps
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -eux
          sudo apt-get update -y
          packages=(
            build-essential cmake make ninja-build pkg-config
            libasound2-dev libpulse-dev libaudio-dev libjack-dev libsndio-dev
            libusb-1.0-0-dev libdbus-1-dev libibus-1.0-dev libudev-dev
            libx11-dev libxext-dev libxrandr-dev libxcursor-dev libxfixes-dev
            libxi-dev libxss-dev libxtst-dev
            libwayland-dev wayland-protocols libxkbcommon-dev libdecor-0-dev
            libdrm-dev libgbm-dev libgl1-mesa-dev libegl1-mesa-dev libgles2-mesa-dev
            libpipewire-0.3-dev
            libfreetype6-dev libharfbuzz-dev   # <-- нужно для SDL_ttf
          )
          sudo apt-get install -y "${packages[@]}"

      # ---------- macOS flags with escaped semicolon ----------
      - name: Prepare CMake extra flags
        id: prep
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            # важно экранировать ';' в outputs
            echo 'extra=-DCMAKE_OSX_ARCHITECTURES=arm64\;x86_64' >> "$GITHUB_OUTPUT"
          else
            echo "extra=" >> "$GITHUB_OUTPUT"
          fi

      # ---------- SDL ----------
      - name: Configure SDL
        shell: bash
        run: |
          cmake -S SDL -B "$BUILD_DIR/SDL" \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            -DSDL_INSTALL=ON \
            ${{ steps.prep.outputs.extra }}

      - name: Build SDL
        shell: bash
        run: cmake --build "$BUILD_DIR/SDL" --config ${CMAKE_BUILD_TYPE} --parallel

      - name: Install SDL
        shell: bash
        run: cmake --install "$BUILD_DIR/SDL" --config ${CMAKE_BUILD_TYPE}

      # ---------- SDL_mixer ----------
      - name: Clone SDL_mixer
        uses: actions/checkout@v4
        with:
          repository: edwardgushchin/SDL_mixer
          fetch-depth: 1
          submodules: recursive
          path: SDL_mixer

      - name: Configure SDL_mixer
        shell: bash
        run: |
          cmake -S SDL_mixer -B "$BUILD_DIR/SDL_mixer" \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            -DCMAKE_PREFIX_PATH="${INSTALL_PREFIX}" \
            -DSDL3MIXER_VENDORED=ON \
            ${{ steps.prep.outputs.extra }}

      - name: Build SDL_mixer
        shell: bash
        run: cmake --build "$BUILD_DIR/SDL_mixer" --config ${CMAKE_BUILD_TYPE} --parallel

      - name: Install SDL_mixer
        shell: bash
        run: cmake --install "$BUILD_DIR/SDL_mixer" --config ${CMAKE_BUILD_TYPE}

      # ---------- SDL_ttf ----------
      - name: Clone SDL_ttf
        uses: actions/checkout@v4
        with:
          repository: edwardgushchin/SDL_ttf
          fetch-depth: 1
          submodules: recursive
          path: SDL_ttf

      - name: Configure SDL_ttf
        shell: bash
        run: |
          cmake -S SDL_ttf -B "$BUILD_DIR/SDL_ttf" \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            -DCMAKE_PREFIX_PATH="${INSTALL_PREFIX}" \
            -DSDL3TTF_VENDORED=ON \
            -DSDL3TTF_HARFBUZZ=ON \
            ${{ steps.prep.outputs.extra }}

      - name: Build SDL_ttf
        shell: bash
        run: cmake --build "$BUILD_DIR/SDL_ttf" --config ${CMAKE_BUILD_TYPE} --parallel

      - name: Install SDL_ttf
        shell: bash
        run: cmake --install "$BUILD_DIR/SDL_ttf" --config ${CMAKE_BUILD_TYPE}

      # ---------- SDL_image ----------
      - name: Clone SDL_image
        uses: actions/checkout@v4
        with:
          repository: edwardgushchin/SDL_image
          fetch-depth: 1
          submodules: recursive
          path: SDL_image

      - name: Configure SDL_image
        shell: bash
        run: |
          cmake -S SDL_image -B "$BUILD_DIR/SDL_image" \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            -DCMAKE_PREFIX_PATH="${INSTALL_PREFIX}" \
            -DSDL3IMAGE_VENDORED=ON \
            ${{ steps.prep.outputs.extra }}

      - name: Build SDL_image
        shell: bash
        run: cmake --build "$BUILD_DIR/SDL_image" --config ${CMAKE_BUILD_TYPE} --parallel

      - name: Install SDL_image
        shell: bash
        run: cmake --install "$BUILD_DIR/SDL_image" --config ${CMAKE_BUILD_TYPE}

      # ---------- SDL_shadercross ----------
      - name: Clone SDL_shadercross
        uses: actions/checkout@v4
        with:
          repository: edwardgushchin/SDL_shadercross
          fetch-depth: 1
          submodules: recursive
          path: SDL_shadercross

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg $env:VCPKG_INSTALLATION_ROOT
          & "$env:VCPKG_INSTALLATION_ROOT\bootstrap-vcpkg.bat" -disableMetrics
      
      - name: Install SPIRV-Cross via vcpkg
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if ("${{ matrix.os }}" -eq "windows-11-arm") {
            $triplet = "arm64-windows"
          } else {
            $triplet = "x64-windows"
          }
          # core + C API; shared чтобы find_package нашёл *-shared config
          $env:VCPKG_DEFAULT_TRIPLET = $triplet
          $env:VCPKG_FEATURE_FLAGS = "manifests,versions,binarycaching"
          & "$env:VCPKG_INSTALLATION_ROOT\vcpkg.exe" install "spirv-cross[core,c]:$triplet" --clean-after-build

      - name: Configure SDL_shadercross
        shell: bash
        run: |
          EXTRA_CMAKE=""
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            if [[ "${{ matrix.os }}" == "windows-11-arm" ]]; then
              TRIPLET=arm64-windows
            else
              TRIPLET=x64-windows
            fi
            EXTRA_CMAKE="-DCMAKE_TOOLCHAIN_FILE=$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=${TRIPLET}"
          fi
          cmake -S SDL_shadercross -B "$BUILD_DIR/SDL_shadercross" \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            -DCMAKE_PREFIX_PATH="${INSTALL_PREFIX}" \
            ${EXTRA_CMAKE} \
            ${{ steps.prep.outputs.extra }}


      - name: Build SDL_shadercross
        shell: bash
        run: cmake --build "$BUILD_DIR/SDL_shadercross" --config ${CMAKE_BUILD_TYPE} --parallel

      - name: Install SDL_shadercross
        shell: bash
        run: cmake --install "$BUILD_DIR/SDL_shadercross" --config ${CMAKE_BUILD_TYPE}

      # ---------- Artifacts ----------
      - name: Collect binaries and install prefix
        shell: bash
        run: |
          set -eux
          mkdir -p "${BUILD_DIR}/artifacts"
          # все динамические библиотеки
          find "$BUILD_DIR" -type f \( -name "*.dll" -o -name "*.so*" -o -name "*.dylib" \) -print -exec cp -v {} "${BUILD_DIR}/artifacts" \; || true
          # install prefix (headers + cmake configs + libs)
          tar -C "${INSTALL_PREFIX}" -czf "${BUILD_DIR}/artifacts/install-prefix.tgz" .

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SDL-suite-main-${{ matrix.os }}
          path: |
            ${{ env.BUILD_DIR }}/artifacts/**
