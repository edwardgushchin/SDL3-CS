name: Build SDL_image

on:
  workflow_dispatch:

jobs:
  build:
    name: Build SDL_image for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, windows-2025, windows-11-arm, macos-13, macos-latest]

    env:
      INSTALL_PREFIX: ${{ github.workspace }}/install
      BUILD_DIR: ${{ github.workspace }}/build
      CMAKE_BUILD_TYPE: Release
      # Поменяй на "1", если хочешь headless-сборку без X11/Wayland на Linux
      HEADLESS: "0"

    steps:
      - name: Clone SDL
        uses: actions/checkout@v4
        with:
          repository: edwardgushchin/SDL
          fetch-depth: 1
          submodules: recursive
          path: SDL

      - name: Clone SDL_image
        uses: actions/checkout@v4
        with:
          repository: edwardgushchin/SDL_image
          fetch-depth: 1
          submodules: recursive
          path: SDL_image

      - name: Install Linux deps
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -eux
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential cmake make ninja-build pkg-config nasm \
            libasound2-dev libpulse-dev libaudio-dev libjack-dev libsndio-dev \
            libusb-1.0-0-dev libdbus-1-dev libibus-1.0-dev libudev-dev \
            libx11-dev libxext-dev libxrandr-dev libxcursor-dev libxfixes-dev \
            libxi-dev libxss-dev libxtst-dev libxrender-dev \
            libwayland-dev wayland-protocols libxkbcommon-dev libdecor-0-dev \
            libdrm-dev libgbm-dev libgl1-mesa-dev libegl1-mesa-dev libgles2-mesa-dev \
            libpipewire-0.3-dev

      - name: Prepare CMake extra flags (macOS universal)
        id: prep
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            echo 'extra=-DCMAKE_OSX_ARCHITECTURES=arm64\;x86_64' >> "$GITHUB_OUTPUT"
          else
            echo "extra=" >> "$GITHUB_OUTPUT"
          fi

      - name: Cache install prefix
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_PREFIX }}
          key: install-prefix-image-${{ runner.os }}-${{ matrix.os }}-v2

      - name: Configure & Install SDL (base)
        shell: bash
        run: |
          EXTRA_SDL_FLAGS="-DSDL_TESTS=OFF -DSDL_EXAMPLES=OFF"
          if [[ "$RUNNER_OS" == "Linux" && "$HEADLESS" == "1" ]]; then
            EXTRA_SDL_FLAGS="$EXTRA_SDL_FLAGS -DSDL_X11=OFF -DSDL_WAYLAND=OFF -DSDL_OFFSCREEN=ON"
          fi

          cmake -S SDL -B "$BUILD_DIR/SDL" \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            -DSDL_INSTALL=ON \
            ${EXTRA_SDL_FLAGS} \
            ${{ steps.prep.outputs.extra }}

          cmake --build "$BUILD_DIR/SDL" --config ${CMAKE_BUILD_TYPE} --parallel
          cmake --install "$BUILD_DIR/SDL" --config ${CMAKE_BUILD_TYPE}

      - name: Configure SDL_image
        shell: bash
        run: |
          cmake -S SDL_image -B "$BUILD_DIR/SDL_image" \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            -DCMAKE_PREFIX_PATH="${INSTALL_PREFIX}" \
            -DSDL3IMAGE_VENDORED=ON \
            -DSDL_TESTS=OFF \
            ${{ steps.prep.outputs.extra }}

      - name: Build & Install SDL_image
        shell: bash
        run: |
          cmake --build "$BUILD_DIR/SDL_image" --config ${CMAKE_BUILD_TYPE} --parallel
          cmake --install "$BUILD_DIR/SDL_image" --config ${CMAKE_BUILD_TYPE}

      - name: Collect & Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SDL_image-${{ matrix.os }}
          path: |
            ${{ env.BUILD_DIR }}/SDL_image/**/*.dll
            ${{ env.BUILD_DIR }}/SDL_image/**/*.so*
            ${{ env.BUILD_DIR }}/SDL_image/**/*.dylib
            ${{ env.INSTALL_PREFIX }}/

