name: Build SDL

on:
  workflow_dispatch:

jobs:
  build:
    name: Build SDL for ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Windows
          - os: windows-2025
            host_os: Windows
            arch_label: x64          # для артефактов
            vs_arch: x64             # для MSVC -A
          - os: windows-11-arm
            host_os: Windows
            arch_label: arm64
            vs_arch: ARM64
          # macOS
          - os: macos-15-intel
            host_os: macOS
            arch_label: x64
            cmake_osx_arch: "-DCMAKE_OSX_ARCHITECTURES=x86_64 -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0"
          - os: macos-latest
            host_os: macOS
            arch_label: arm64
            cmake_osx_arch: "-DCMAKE_OSX_ARCHITECTURES=arm64 -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0"
          # Linux
          - os: ubuntu-latest
            host_os: Linux
            arch_label: x64
          - os: ubuntu-24.04-arm
            host_os: Linux
            arch_label: arm64


    env:
      INSTALL_PREFIX: ${{ github.workspace }}/install
      BUILD_DIR: ${{ github.workspace }}/build
      CMAKE_BUILD_TYPE: Release

    steps:
      - name: Clone SDL
        uses: actions/checkout@v4
        with:
          repository: edwardgushchin/SDL
          fetch-depth: 1
          submodules: recursive
          path: SDL

      # Linux deps (без проблемного libibus-1.0-1)
      - name: Install Linux deps
        if: matrix.host_os == 'Linux'
        shell: bash
        run: |
          set -eux
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential cmake make ninja-build pkg-config \
            libasound2-dev libpulse-dev libaudio-dev libjack-dev libsndio-dev \
            libusb-1.0-0-dev libdbus-1-dev libudev-dev \
            libx11-dev libxext-dev libxrandr-dev libxcursor-dev libxfixes-dev \
            libxi-dev libxss-dev libxtst-dev \
            libwayland-dev wayland-protocols libxkbcommon-dev libdecor-0-dev \
            libdrm-dev libgbm-dev libgl1-mesa-dev libegl1-mesa-dev libgles2-mesa-dev \
            libpipewire-0.3-dev

      - name: Prepare CMake flags (macOS)
        if: matrix.host_os == 'macOS'
        id: prep
        shell: bash
        run: echo "extra=${{ matrix.cmake_osx_arch }}" >> "$GITHUB_OUTPUT"

      - name: Configure SDL
        shell: bash
        run: |
          GEN=""
          if [[ "${{ matrix.host_os }}" == "Windows" ]]; then
            GEN='-G "Visual Studio 17 2022" -A ${{ matrix.vs_arch }}'
          fi
          cmake -S SDL -B "$BUILD_DIR/SDL" \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            -DSDL_INSTALL=ON \
            ${GEN} \
            ${{ steps.prep.outputs.extra }}

      - name: Build SDL
        shell: bash
        run: cmake --build "$BUILD_DIR/SDL" --config ${CMAKE_BUILD_TYPE} --parallel

      - name: Install SDL
        shell: bash
        run: cmake --install "$BUILD_DIR/SDL" --config ${CMAKE_BUILD_TYPE}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SDL_image-${{ matrix.os }}-${{ matrix.arch_label }}
          path: |
            ${{ env.BUILD_DIR }}/SDL/**/*.dll
            ${{ env.BUILD_DIR }}/SDL/**/*.so*
            ${{ env.BUILD_DIR }}/SDL/**/*.dylib
            ${{ env.INSTALL_PREFIX }}/
