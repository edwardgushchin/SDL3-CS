name: Build SDL_shadercross

on:
  workflow_dispatch:

jobs:
  build:
    name: Build SDL_shadercross for ${{ matrix.os }} (${{ matrix.arch_label }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - os: windows-2025
            host_os: Windows
            arch_label: x64
            vs_arch: x64
            triplet: x64-windows
          - os: windows-11-arm
            host_os: Windows
            arch_label: arm64
            vs_arch: ARM64
            triplet: arm64-windows

          # macOS
          - os: macos-15-intel
            host_os: macOS
            arch_label: x64
            triplet: x64-osx
            cmake_osx_arch: -DCMAKE_OSX_ARCHITECTURES=x86_64 -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0
          - os: macos-latest
            host_os: macOS
            arch_label: arm64
            triplet: arm64-osx
            cmake_osx_arch: -DCMAKE_OSX_ARCHITECTURES=arm64 -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0

          # Linux
          - os: ubuntu-latest
            host_os: Linux
            arch_label: x64
            triplet: x64-linux
          - os: ubuntu-24.04-arm
            host_os: Linux
            arch_label: arm64
            triplet: arm64-linux

    env:
      INSTALL_PREFIX: ${{ github.workspace }}/install
      BUILD_DIR: ${{ github.workspace }}/build
      CMAKE_BUILD_TYPE: Release

    steps:
      # ---------- Sources ----------
      - name: Checkout SDL_shadercross
        uses: actions/checkout@v4
        with:
          repository: edwardgushchin/SDL_shadercross
          fetch-depth: 1
          submodules: recursive
          path: SDL_shadercross

      # ---------- Base toolchain ----------
      - name: Install base tools (Linux)
        if: matrix.host_os == 'Linux'
        shell: bash
        run: |
          set -eux
          sudo apt-get update -y
          sudo apt-get install -y build-essential cmake ninja-build pkg-config git

      # ---------- vcpkg on all OS (we use it for SDL3 everywhere; DXC on Win + Linux x64) ----------
      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: ${{ (matrix.host_os == 'Windows') && format('{0}\\vcpkg', env.USERPROFILE) || format('{0}/vcpkg', env.HOME) }}
          key: vcpkg-${{ matrix.os }}-${{ matrix.triplet }}-v1

      - name: Bootstrap vcpkg
        shell: bash
        run: |
          set -eux
          if [[ "${{ matrix.host_os }}" == "Windows" ]]; then
            VCPKG_ROOT="$(cygpath -u "$USERPROFILE")/vcpkg"
          else
            VCPKG_ROOT="$HOME/vcpkg"
          fi
          if [[ ! -d "$VCPKG_ROOT/.git" ]]; then
            git clone https://github.com/microsoft/vcpkg "$VCPKG_ROOT"
          else
            git -C "$VCPKG_ROOT" fetch --depth=1 origin
            git -C "$VCPKG_ROOT" reset --hard origin/master
          fi
          if [[ "${{ matrix.host_os }}" == "Windows" ]]; then
            "$VCPKG_ROOT/bootstrap-vcpkg.bat" -disableMetrics
          else
            "$VCPKG_ROOT/bootstrap-vcpkg.sh" -disableMetrics
          fi
          echo "VCPKG_INSTALLATION_ROOT=$VCPKG_ROOT" >> "$GITHUB_ENV"

      # ---------- Install SDL3 via vcpkg (all platforms) ----------
      - name: Install SDL3 via vcpkg
        shell: bash
        run: |
          set -eux
          if [[ "${{ matrix.host_os }}" == "Windows" ]]; then
            "$VCPKG_INSTALLATION_ROOT/vcpkg" install "sdl3:${{ matrix.triplet }}" --clean-after-build
          else
            "$VCPKG_INSTALLATION_ROOT/vcpkg" install "sdl3:${{ matrix.triplet }}"
          fi

      # ---------- Install DXC via vcpkg (Windows + Linux x64 only) ----------
      - name: Install DXC via vcpkg (Win + Linux x64)
        if: (matrix.host_os == 'Windows') || (matrix.host_os == 'Linux' && matrix.arch_label == 'x64')
        shell: bash
        run: |
          set -eux
          "$VCPKG_INSTALLATION_ROOT/vcpkg" install "directx-dxc:${{ matrix.triplet }}" || \
          "$VCPKG_INSTALLATION_ROOT/vcpkg" install "dxcompiler:${{ matrix.triplet }}" || true

      # ---------- SPIRV-Cross (build from source; provides C API shared) ----------
      - name: Build & Install SPIRV-Cross
        shell: bash
        run: |
          set -eux
          git clone --depth=1 https://github.com/KhronosGroup/SPIRV-Cross.git
          cmake -S SPIRV-Cross -B build_spvc \
            -DSPIRV_CROSS_ENABLE_C_API=ON \
            -DSPIRV_CROSS_SHARED=ON \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            ${{ matrix.cmake_osx_arch || '' }}
          cmake --build build_spvc --config ${CMAKE_BUILD_TYPE} --parallel
          cmake --install build_spvc --config ${CMAKE_BUILD_TYPE}

      # ---------- Cache install prefix ----------
      - name: Cache install prefix
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_PREFIX }}
          key: install-prefix-shadercross-${{ matrix.os }}-${{ matrix.arch_label }}-v1

      # ---------- Configure SDL_shadercross ----------
      - name: Configure SDL_shadercross
        shell: bash
        run: |
          set -eux

          # Where vcpkg installs things
          VCPKG_TRIPLET="${{ matrix.triplet }}"
          VCPKG_ROOT="$VCPKG_INSTALLATION_ROOT"
          VCPKG_PREFIX="$VCPKG_ROOT/installed/$VCPKG_TRIPLET"

          # Toolchain + triplet only where we really need it (Win always; Linux x64 for DXC; others optional)
          EXTRA_CMAKE=""
          if [[ "${{ matrix.host_os }}" == "Windows" ]]; then
            EXTRA_CMAKE="-DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=$VCPKG_TRIPLET"
          elif [[ "${{ matrix.host_os }}" == "Linux" && "${{ matrix.arch_label }}" == "x64" ]]; then
            EXTRA_CMAKE="-DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=$VCPKG_TRIPLET"
          fi

          # SDL3 hint (find_package(SDL3 ...))
          SDL3_DIR_HINT="$VCPKG_PREFIX/share/SDL3"
          SDL_HINT=""
          [[ -d "$SDL3_DIR_HINT" ]] && SDL_HINT="-DSDL3_DIR=$SDL3_DIR_HINT"

          # SPIRV-Cross hint
          SPVC_HINT=""
          CANDIDATE="${INSTALL_PREFIX}/lib/cmake/spirv_cross_c_shared"
          [[ -d "$CANDIDATE" ]] && SPVC_HINT="-Dspirv_cross_c_shared_DIR=$CANDIDATE"

          # DXC hints (only where installed)
          DXC_HINTS=""
          if [[ ( "${{ matrix.host_os }}" == "Windows" ) || ( "${{ matrix.host_os }}" == "Linux" && "${{ matrix.arch_label }}" == "x64" ) ]]; then
            DXC_INC="$VCPKG_PREFIX/include"
            if [[ "${{ matrix.host_os }}" == "Windows" ]]; then
              DXC_LIBC="$VCPKG_PREFIX/lib/dxcompiler.lib"
              DXC_LIBL="$VCPKG_PREFIX/lib/dxil.lib"
            else
              DXC_LIBC="$VCPKG_PREFIX/lib/libdxcompiler.so"
              DXC_LIBL="$VCPKG_PREFIX/lib/libdxil.so"
            fi
            if [[ -f "$DXC_LIBC" && -f "$DXC_LIBL" ]]; then
              DXC_HINTS="-DDirectXShaderCompiler_INCLUDE_PATH=$DXC_INC -DDirectXShaderCompiler_dxcompiler_LIBRARY=$DXC_LIBC -DDirectXShaderCompiler_dxil_LIBRARY=$DXC_LIBL"
            fi
          fi

          # On platforms without DXC we must explicitly disable its REQUIRED find
          DXC_OFF_FLAGS=""
          if [[ ( "${{ matrix.host_os }}" == "macOS" ) || ( "${{ matrix.host_os }}" == "Linux" && "${{ matrix.arch_label }}" != "x64" ) ]]; then
            DXC_OFF_FLAGS="-DSC_WITH_DXC=OFF -DCMAKE_DISABLE_FIND_PACKAGE_DirectXShaderCompiler=ON"
          fi

          # Prefix path: our local install + vcpkg prefix
          CMAKE_PREFIX="${INSTALL_PREFIX};${VCPKG_PREFIX}"

          cmake -S SDL_shadercross -B "$BUILD_DIR/SDL_shadercross" \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            -DCMAKE_PREFIX_PATH="${CMAKE_PREFIX}" \
            ${EXTRA_CMAKE} \
            ${SDL_HINT} \
            ${SPVC_HINT} \
            ${DXC_HINTS} \
            ${DXC_OFF_FLAGS} \
            ${{ matrix.cmake_osx_arch || '' }}

      # ---------- Build / Install ----------
      - name: Build SDL_shadercross
        shell: bash
        run: cmake --build "$BUILD_DIR/SDL_shadercross" --config ${CMAKE_BUILD_TYPE} --parallel

      - name: Install SDL_shadercross
        shell: bash
        run: cmake --install "$BUILD_DIR/SDL_shadercross" --config ${CMAKE_BUILD_TYPE}

      # ---------- Artifacts ----------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SDL_shadercross-${{ matrix.os }}-${{ matrix.arch_label }}
          path: |
            ${{ env.BUILD_DIR }}/SDL_shadercross/**/*.dll
            ${{ env.BUILD_DIR }}/SDL_shadercross/**/*.so*
            ${{ env.BUILD_DIR }}/SDL_shadercross/**/*.dylib
            ${{ env.INSTALL_PREFIX }}/
