name: Build SDL_shadercross

on:
  workflow_dispatch:

jobs:
  build:
    name: Build SDL_shadercross for ${{ matrix.os }} (${{ matrix.arch_label }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-2025
            host_os: Windows
            arch_label: x64
            vs_arch: x64
            triplet: x64-windows
          - os: windows-11-arm
            host_os: Windows
            arch_label: arm64
            vs_arch: ARM64
            triplet: arm64-windows
          - os: macos-15-intel
            host_os: macOS
            arch_label: x64
            triplet: x64-osx
            cmake_osx_arch: -DCMAKE_OSX_ARCHITECTURES=x86_64 -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0
          - os: macos-latest
            host_os: macOS
            arch_label: arm64
            triplet: arm64-osx
            cmake_osx_arch: -DCMAKE_OSX_ARCHITECTURES=arm64 -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0
          - os: ubuntu-latest
            host_os: Linux
            arch_label: x64
            triplet: x64-linux
          - os: ubuntu-24.04-arm
            host_os: Linux
            arch_label: arm64
            triplet: arm64-linux

    env:
      INSTALL_PREFIX: ${{ github.workspace }}/install
      BUILD_DIR: ${{ github.workspace }}/build
      CMAKE_BUILD_TYPE: Release

    steps:
      - name: Checkout SDL (your fork)
        uses: actions/checkout@v4
        with:
          repository: edwardgushchin/SDL
          fetch-depth: 1
          submodules: recursive
          path: SDL

      - name: Checkout SDL_shadercross
        uses: actions/checkout@v4
        with:
          repository: edwardgushchin/SDL_shadercross
          fetch-depth: 1
          submodules: recursive
          path: SDL_shadercross

      - name: Install Linux deps
        if: matrix.host_os == 'Linux'
        shell: bash
        run: |
          set -eux
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential cmake ninja-build pkg-config git \
            libx11-dev libxext-dev libxrandr-dev libxcursor-dev libxfixes-dev \
            libxi-dev libxrender-dev libxss-dev libxtst-dev \
            libwayland-dev wayland-protocols libxkbcommon-dev libdecor-0-dev \
            libgl1-mesa-dev libegl1-mesa-dev libgles2-mesa-dev libvulkan-dev \
            libudev-dev libdrm-dev libgbm-dev autoconf autoconf-archive automake libtool

      - name: Configure SDL (Windows)
        if: matrix.host_os == 'Windows'
        shell: pwsh
        run: |
          $args = @(
            "-S","SDL",
            "-B","$env:BUILD_DIR/SDL",
            "-G","Visual Studio 17 2022",
            "-A","${{ matrix.vs_arch }}",
            "-DCMAKE_BUILD_TYPE=$env:CMAKE_BUILD_TYPE",
            "-DCMAKE_INSTALL_PREFIX=$env:INSTALL_PREFIX",
            "-DSDL_INSTALL=ON",
            "-DSDL_TESTS=OFF","-DSDL_EXAMPLES=OFF",
            "-DSDL_VIDEO=ON","-DSDL_RENDER=ON"
          )
          cmake @args

      - name: Configure SDL (Unix)
        if: matrix.host_os != 'Windows'
        shell: bash
        run: |
          set -eux
          cmake -S SDL -B "$BUILD_DIR/SDL" \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            -DSDL_INSTALL=ON \
            -DSDL_TESTS=OFF -DSDL_EXAMPLES=OFF \
            -DSDL_VIDEO=ON -DSDL_RENDER=ON \
            -DSDL_X11=ON -DSDL_WAYLAND=ON \
            -DSDL_OPENGL=ON -DSDL_OPENGLES=ON -DSDL_VULKAN=ON \
            ${{ matrix.cmake_osx_arch || '' }}

      - name: Build SDL
        shell: bash
        run: cmake --build "$BUILD_DIR/SDL" --config ${CMAKE_BUILD_TYPE} --parallel

      - name: Install SDL
        shell: bash
        run: cmake --install "$BUILD_DIR/SDL" --config ${CMAKE_BUILD_TYPE}

      - name: Cache vcpkg
        if: (matrix.host_os == 'Windows') || (matrix.host_os == 'Linux' && matrix.arch_label == 'x64')
        uses: actions/cache@v4
        with:
          path: ${{ (matrix.host_os == 'Windows') && format('{0}\\vcpkg', env.USERPROFILE) || format('{0}/vcpkg', env.HOME) }}
          key: vcpkg-${{ matrix.os }}-${{ matrix.triplet }}-dxc-v1

      - name: Bootstrap vcpkg
        if: (matrix.host_os == 'Windows') || (matrix.host_os == 'Linux' && matrix.arch_label == 'x64')
        shell: bash
        run: |
          set -eux
          if [[ "${{ matrix.host_os }}" == "Windows" ]]; then
            VCPKG_ROOT="$(cygpath -u "$USERPROFILE")/vcpkg"
          else
            VCPKG_ROOT="$HOME/vcpkg"
          fi
          if [[ ! -d "$VCPKG_ROOT/.git" ]]; then
            git clone https://github.com/microsoft/vcpkg "$VCPKG_ROOT"
          else
            git -C "$VCPKG_ROOT" fetch --depth=1 origin
            git -C "$VCPKG_ROOT" reset --hard origin/master
          fi
          if [[ "${{ matrix.host_os }}" == "Windows" ]]; then
            "$VCPKG_ROOT/bootstrap-vcpkg.bat" -disableMetrics
          else
            "$VCPKG_ROOT/bootstrap-vcpkg.sh" -disableMetrics
          fi
          echo "VCPKG_INSTALLATION_ROOT=$VCPKG_ROOT" >> "$GITHUB_ENV"

      - name: Install DXC via vcpkg
        if: (matrix.host_os == 'Windows') || (matrix.host_os == 'Linux' && matrix.arch_label == 'x64')
        shell: bash
        run: |
          set -eux
          "$VCPKG_INSTALLATION_ROOT/vcpkg" install "directx-dxc:${{ matrix.triplet }}" || \
          "$VCPKG_INSTALLATION_ROOT/vcpkg" install "dxcompiler:${{ matrix.triplet }}" || true

      - name: Build & Install SPIRV-Cross
        shell: bash
        run: |
          set -eux
          git clone --depth=1 https://github.com/KhronosGroup/SPIRV-Cross.git
          cmake -S SPIRV-Cross -B build_spvc \
            -DSPIRV_CROSS_ENABLE_C_API=ON \
            -DSPIRV_CROSS_SHARED=ON \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            ${{ matrix.cmake_osx_arch || '' }}
          cmake --build build_spvc --config ${CMAKE_BUILD_TYPE} --parallel
          cmake --install build_spvc --config ${CMAKE_BUILD_TYPE}

      - name: Configure SDL_shadercross
        shell: bash
        run: |
          set -eux
      
          # Подсказка для SDL3 (не обязательно, но пусть будет)
          SDL3_DIR_CANDIDATES=("${INSTALL_PREFIX}/lib/cmake/SDL3" "${INSTALL_PREFIX}/share/SDL3")
          SDL_HINT=""
          for d in "${SDL3_DIR_CANDIDATES[@]}"; do
            if [[ -f "$d/SDL3Config.cmake" ]]; then SDL_HINT="-DSDL3_DIR=$d"; break; fi
          done
      
          # Готовим флаги DXC и префиксы поиска пакетов
          DXC_FLAG=""
          DXC_ROOT=""
          EXTRA_PREFIX=""
      
          if [[ "${{ matrix.host_os }}" == "Windows" ]]; then
            VCPKG_PREFIX="$VCPKG_INSTALLATION_ROOT/installed/${{ matrix.triplet }}"
            if [[ -f "$VCPKG_PREFIX/include/dxcapi.h" && -f "$VCPKG_PREFIX/lib/dxcompiler.lib" ]]; then
              DXC_FLAG="-DSDLSHADERCROSS_DXC=ON"
              DXC_ROOT="-DDirectXShaderCompiler_ROOT=$VCPKG_PREFIX"
              EXTRA_PREFIX=";$VCPKG_PREFIX"
            else
              DXC_FLAG="-DSDLSHADERCROSS_DXC=OFF"
            fi
          elif [[ "${{ matrix.host_os }}" == "Linux" && "${{ matrix.arch_label }}" == "x64" ]]; then
            VCPKG_PREFIX="$VCPKG_INSTALLATION_ROOT/installed/${{ matrix.triplet }}"
            if [[ -f "$VCPKG_PREFIX/include/dxcapi.h" && -f "$VCPKG_PREFIX/lib/libdxcompiler.so" ]]; then
              DXC_FLAG="-DSDLSHADERCROSS_DXC=ON"
              DXC_ROOT="-DDirectXShaderCompiler_ROOT=$VCPKG_PREFIX"
              EXTRA_PREFIX=";$VCPKG_PREFIX"
            else
              DXC_FLAG="-DSDLSHADERCROSS_DXC=OFF"
            fi
          else
            # macOS и Linux ARM64 — DXC обычно недоступен
            DXC_FLAG="-DSDLSHADERCROSS_DXC=OFF"
          fi
      
          # Конфигурируем проект
          cmake -S SDL_shadercross -B "$BUILD_DIR/SDL_shadercross" \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
            -DCMAKE_PREFIX_PATH="${INSTALL_PREFIX}${EXTRA_PREFIX}" \
            -DSDLSHADERCROSS_INSTALL=ON \
            -DSDLSHADERCROSS_SHARED=ON \
            -DSDLSHADERCROSS_STATIC=ON \
            -DSDLSHADERCROSS_CLI=OFF \
            ${SDL_HINT} \
            ${DXC_FLAG} \
            ${DXC_ROOT} \
            ${{ matrix.cmake_osx_arch || '' }}

      - name: Build SDL_shadercross
        shell: bash
        run: cmake --build "$BUILD_DIR/SDL_shadercross" --config ${CMAKE_BUILD_TYPE} --parallel

      - name: Install SDL_shadercross
        shell: bash
        run: cmake --install "$BUILD_DIR/SDL_shadercross" --config ${CMAKE_BUILD_TYPE}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SDL_shadercross-${{ matrix.os }}-${{ matrix.arch_label }}
          path: |
            ${{ env.INSTALL_PREFIX }}/include/**
            ${{ env.INSTALL_PREFIX }}/lib/**
            ${{ env.INSTALL_PREFIX }}/bin/**
            ${{ env.INSTALL_PREFIX }}/lib/cmake/SDL3_shadercross/**
